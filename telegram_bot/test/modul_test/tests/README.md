# Модульные тесты для проекта психологической помощи

Этот каталог содержит модульные тесты для основных компонентов системы психологической помощи.

## Структура тестов

1. **test_database.py** - тесты для функций работы с базой данных (7 тестов):
   - Инициализация базы данных и создание таблиц
   - Логирование диалогов пользователей
   - Логирование рекомендаций книг
   - Получение диалогов пользователя по ID
   - Получение рекомендаций пользователя
   - Обработка несуществующих записей

2. **test_dialogue.py** - тесты для функций обработки диалогов (5 тестов):
   - Инициализация диалога с системными промптами
   - Получение ответов от LLM (с моками OpenAI API)
   - Чтение сообщений из JSON файлов
   - Основная функция чата
   - Обработка недопустимых issue_id

3. **test_books.py** - тесты для функций рекомендации книг (5 тестов):
   - Создание промптов для рекомендаций на основе диалогов
   - Получение рекомендаций от LLM (с моками)
   - Форматирование рекомендаций в читаемый текст
   - Получение рекомендаций из файлов диалогов
   - Обработка ошибок при парсинге JSON ответов

4. **test_runner.py** - скрипт для запуска всех тестов вместе

5. **test_reporter.py** - модуль для генерации HTML-отчетов о тестировании

**Всего: 17 тестов** покрывающих основную функциональность системы психологической помощи.

## Запуск тестов

### Запуск всех тестов с генерацией отчета

```bash
py -m telegram_bot.test.modul_test.tests.test_runner
# или
python -m telegram_bot.test.modul_test.tests.test_runner
```

После выполнения будет создан HTML-отчет в директории `telegram_bot/test/modul_test/tests/reports/`. Отчет содержит информацию о всех запущенных тестах, их статусе, времени выполнения и подробности об ошибках (если есть).

### Запуск отдельных тестовых модулей

```bash
# С подробным выводом (-v)
py -m unittest telegram_bot.test.modul_test.tests.test_database -v
py -m unittest telegram_bot.test.modul_test.tests.test_dialogue -v
py -m unittest telegram_bot.test.modul_test.tests.test_books -v

# Без подробного вывода
py -m unittest telegram_bot.test.modul_test.tests.test_database
py -m unittest telegram_bot.test.modul_test.tests.test_dialogue
py -m unittest telegram_bot.test.modul_test.tests.test_books
```

### Запуск конкретного теста

```bash
py -m unittest telegram_bot.test.modul_test.tests.test_database.TestDatabase.test_log_dialogue
# или любой другой конкретный тест
py -m unittest telegram_bot.test.modul_test.tests.test_dialogue.TestDialogue.test_initialize_dialogue
```

## Генерация отчетов

При каждом запуске тестов через `test_runner.py` автоматически создаются:

1. **HTML-отчет с временной меткой** - подробный отчет о результатах текущего запуска тестов
2. **latest_report.html** - копия последнего отчета для быстрого доступа
3. **index.html** - страница с историей всех запусков и ссылками на отчеты

Все отчеты сохраняются в директории `telegram_bot/test/modul_test/tests/reports/`.

### Просмотр отчетов

```bash
# Открыть последний отчет в браузере
start telegram_bot/test/modul_test/tests/reports/latest_report.html

# Открыть индексную страницу со всеми отчетами
start telegram_bot/test/modul_test/tests/reports/index.html

# Просмотреть список всех отчетов
dir telegram_bot/test/modul_test/tests/reports/
```

### Что содержит отчет

- Общая сводка результатов тестирования (количество успешных/неудачных/пропущенных тестов)
- Время начала и окончания тестирования
- Подробная информация о каждом тесте (статус, описание)
- Детальная информация об ошибках и исключениях
- Группировка тестов по модулям и классам

## Особенности тестов

- Все тесты используют временную директорию для хранения тестовой базы данных
- Внешние зависимости (OpenAI API) мокируются для тестирования без реальных вызовов API
- Каждый тест запускается в изолированном окружении и не влияет на другие тесты
- После выполнения тестов все временные данные удаляются

## Добавление новых тестов

При разработке новых функций рекомендуется добавлять соответствующие тесты. Для этого:

1. Создайте новый тестовый метод в соответствующем классе тестов
2. Следуйте шаблону существующих тестов: подготовка данных, вызов тестируемой функции, проверка результатов
3. Используйте моки для внешних зависимостей
4. Запустите тесты, чтобы убедиться, что новый тест проходит
